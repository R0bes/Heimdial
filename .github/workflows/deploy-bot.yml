name: Deploy Bot (Direct)

on:
  push:
    branches:
      - main
    paths:
      - 'bot/**'
      - '.github/workflows/deploy-bot.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd bot
          pip install -r requirements.txt
      
      - name: Stop existing bot (Linux)
        if: runner.os == 'Linux'
        run: |
          if [ -f bot/bot.pid ]; then
            PID=$(cat bot/bot.pid)
            if ps -p $PID > /dev/null 2>&1; then
              kill $PID
              echo "Stopped existing bot (PID: $PID)"
            fi
            rm -f bot/bot.pid
          fi
        continue-on-error: true
      
      - name: Stop existing bot (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (Test-Path bot/bot.pid) {
            $PID = Get-Content bot/bot.pid
            $process = Get-Process -Id $PID -ErrorAction SilentlyContinue
            if ($process) {
              Stop-Process -Id $PID -Force
              Write-Host "Stopped existing bot (PID: $PID)"
            }
            Remove-Item bot/bot.pid -ErrorAction SilentlyContinue
          }
        continue-on-error: true
      
      - name: Start bot (Linux)
        if: runner.os == 'Linux'
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          ALLOWED_USER_IDS: ${{ secrets.ALLOWED_USER_IDS }}
          WEBAPP_URL: ${{ secrets.WEBAPP_URL }}
        run: |
          cd bot
          nohup python bot.py > bot.log 2>&1 &
          echo $! > bot.pid
          echo "Bot started with PID: $(cat bot.pid)"
      
      - name: Start bot (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          ALLOWED_USER_IDS: ${{ secrets.ALLOWED_USER_IDS }}
          WEBAPP_URL: ${{ secrets.WEBAPP_URL }}
        run: |
          cd bot
          $process = Start-Process -FilePath "python" -ArgumentList "bot.py" -PassThru -NoNewWindow -RedirectStandardOutput "bot.log" -RedirectStandardError "bot.log"
          $process.Id | Out-File -FilePath "bot.pid" -Encoding ASCII
          Write-Host "Bot started with PID: $($process.Id)"
      
      - name: Verify bot is running (Linux)
        if: runner.os == 'Linux'
        run: |
          sleep 2
          if [ -f bot/bot.pid ]; then
            PID=$(cat bot/bot.pid)
            if ps -p $PID > /dev/null 2>&1; then
              echo "✅ Bot is running (PID: $PID)"
            else
              echo "❌ Bot failed to start"
              cat bot/bot.log || true
              exit 1
            fi
          else
            echo "❌ Bot PID file not found"
            exit 1
          fi
      
      - name: Verify bot is running (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Start-Sleep -Seconds 2
          if (Test-Path bot/bot.pid) {
            $PID = Get-Content bot/bot.pid
            $process = Get-Process -Id $PID -ErrorAction SilentlyContinue
            if ($process) {
              Write-Host "✅ Bot is running (PID: $PID)"
            } else {
              Write-Host "❌ Bot failed to start"
              Get-Content bot/bot.log -ErrorAction SilentlyContinue
              exit 1
            }
          } else {
            Write-Host "❌ Bot PID file not found"
            exit 1
          }
