name: Deploy Bot to Self-Hosted Runner

on:
  push:
    branches: [main]
    paths:
      - 'bot/**'
      - '.github/workflows/deploy-bot.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'bot/requirements.txt'
      
      - name: Install dependencies
        run: |
          cd bot
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Stop old bot instance
        run: |
          if [ -f bot/bot.pid ]; then
            OLD_PID=$(cat bot/bot.pid)
            if ps -p $OLD_PID > /dev/null 2>&1; then
              echo "Stopping bot with PID $OLD_PID"
              kill $OLD_PID
              sleep 2
            fi
            rm bot/bot.pid
          fi
          # Fallback: kill by process name
          pkill -f "python.*bot.py" || true
          sleep 2
      
      - name: Start new bot instance
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          ALLOWED_USER_IDS: ${{ secrets.ALLOWED_USER_IDS }}
          WEBAPP_URL: ${{ secrets.WEBAPP_URL }}
        run: |
          cd bot
          nohup python bot.py > bot.log 2>&1 &
          echo $! > bot.pid
          sleep 3
      
      - name: Verify bot is running
        run: |
          if [ -f bot/bot.pid ]; then
            BOT_PID=$(cat bot/bot.pid)
            if ps -p $BOT_PID > /dev/null 2>&1; then
              echo "✅ Bot is running with PID $BOT_PID"
              exit 0
            else
              echo "❌ Bot failed to start"
              echo "--- Log output ---"
              cat bot/bot.log
              exit 1
            fi
          else
            echo "❌ PID file not found"
            exit 1
